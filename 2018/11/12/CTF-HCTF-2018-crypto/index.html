<!DOCTYPE html>
<html>
  <head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport">
  <meta name="description" content="r1ngs&#39;s blog">
  <meta name="keyword" content="hexo-theme, vuejs">
  
    <link rel="shortcut icon" href="/css/images/logo.png">
  
  <title>
    
      HCTF-2018-crypto和一些思考 | r1ngs&#39;s blog
    
  </title>
  <link href="//cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet">
  <link href="//cdn.bootcss.com/nprogress/0.2.0/nprogress.min.css" rel="stylesheet">
  <link href="//cdn.bootcss.com/highlight.js/9.12.0/styles/tomorrow.min.css" rel="stylesheet">
  <link rel="stylesheet" href="/css/style.css">
<link rel="stylesheet" href="/css/plugins/gitment.css">
  <script src="//cdn.bootcss.com/jquery/3.2.1/jquery.min.js"></script>
  <script src="//cdn.bootcss.com/geopattern/1.2.3/js/geopattern.min.js"></script>
  <script src="//cdn.bootcss.com/nprogress/0.2.0/nprogress.min.js"></script>
  <script src="/js/qrious.js"></script>
<script src="/js/gitment.js"></script>
  
  
    <!-- MathJax support START -->
    <script type="text/x-mathjax-config">
      MathJax.Hub.Config({
        tex2jax: {
          inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
          processEscapes: true,
          skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
        }
      });
    </script>

    <script type="text/x-mathjax-config">
      MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax(), i;
        for (i=0; i < all.length; i += 1) {
          all[i].SourceElement().parentNode.className += ' has-jax';
        }
      });
    </script>
    <script type="text/javascript" src="//cdn.bootcss.com/mathjax/2.7.1/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <!-- MathJax support END -->
  


</head>
<div class="wechat-share">
  <img src="/css/images/logo.png" />
</div>

  <body>
    <header class="header fixed-header">
  <div class="header-container">
    <a class="home-link" href="/">
      <div class="logo"></div>
      <span>r1ngs's blog</span>
    </a>
    <ul class="right-list">
      
        <li class="list-item">
          
            <a href="/" class="item-link">Home</a>
          
        </li>
      
        <li class="list-item">
          
            <a href="/tags/" class="item-link">Tags</a>
          
        </li>
      
        <li class="list-item">
          
            <a href="/archives/" class="item-link">Archives</a>
          
        </li>
      
        <li class="list-item">
          
            <a href="/about/" class="item-link">About</a>
          
        </li>
      
    </ul>
    <div class="menu">
      <span class="icon-bar"></span>
      <span class="icon-bar"></span>
      <span class="icon-bar"></span>
    </div>
    <div class="menu-mask">
      <ul class="menu-list">
        
          <li class="menu-item">
            
              <a href="/" class="menu-link">Home</a>
            
          </li>
        
          <li class="menu-item">
            
              <a href="/tags/" class="menu-link">Tags</a>
            
          </li>
        
          <li class="menu-item">
            
              <a href="/archives/" class="menu-link">Archives</a>
            
          </li>
        
          <li class="menu-item">
            
              <a href="/about/" class="menu-link">About</a>
            
          </li>
        
      </ul>
    </div>
  </div>
</header>

    <div id="article-banner">
  <h2>HCTF-2018-crypto和一些思考</h2>
  <p class="post-date">2018-11-12</p>
  <div class="arrow-down">
    <a href="javascript:;"></a>
  </div>
</div>
<main class="app-body flex-box">
  <!-- Article START -->
  <article class="post-article">
    <section class="markdown-content"><p>又是一场产出为0的比赛</p>
<p><img src="/2018/11/12/CTF-HCTF-2018-crypto/1.jpg" alt=""></p>
<a id="more"></a>
<h2 id="xor-game"><a href="#xor-game" class="headerlink" title="xor game"></a>xor game</h2><h3 id="题解"><a href="#题解" class="headerlink" title="题解"></a>题解</h3><p>题目代码</p>
<pre><code class="lang-python">from Crypto.Util.strxor import strxor
import base64
import random


def enc(data, key):
    key = (key * (len(data) / len(key) + 1))[:len(data)]
    return strxor(data, key)


poem = open(&#39;poem.txt&#39;, &#39;r&#39;).read()
flag = &quot;hctf{xxxxxxxxxxx}&quot;

with open(&#39;cipher.txt&#39;, &#39;w&#39;) as f:
    f.write(base64.b64encode(enc(poem, flag[5:-1])))
    f.close()
</code></pre>
<p>之前在DCTF上遇到过类似的题目，<a href="https://github.com/scai16/CTF/tree/master/2018/DefCamp%20CTF%202018/XORnigma" target="_blank" rel="noopener">writeup</a></p>
<p>但是这道题至少可以依据前四个字节都是0和flag格式为DCTF{…}来有依据猜，但是这道题猜都不能猜</p>
<p>在google上搜索ctf xor repeate key ，我发现了这篇文章<a href="https://ehsandev.com/pico2014/cryptography/repeated_xor.html" target="_blank" rel="noopener">Repeated XOR - 70</a></p>
<p>文章揭露了可以使用频度分析的方式来达到攻击从而推测出明文的结果，博主还非常良心的贴出了完整的脚本</p>
<p>由于整篇poem比较长，一共有1398个字节，所以我试着跑了一下</p>
<p><img src="/2018/11/12/CTF-HCTF-2018-crypto/2.jpg" alt=""></p>
<p>可以看到，密钥长度为21的可能性比较大，调成21，再跑一下poem</p>
<p><img src="/2018/11/12/CTF-HCTF-2018-crypto/3.jpg" alt=""></p>
<p>可以看到虽然大部分是乱码，但是已经零零散散有一些单词了，可惜当时做到这里的时候就以为自己思路有问题，所以就没有继续往下面做了，如果接着往下面做，将密钥打印出来：</p>
<p><code>6o7i6_i+te7es1ing!@#</code></p>
<p>第3位是一个不可见字符，flag里面肯定不可能是不可见的字符，所以我们暂时令他为1</p>
<p>然后我们跑一下下面的代码</p>
<pre><code class="lang-python">from Crypto.Util.strxor import strxor
import base64
from string import *


def enc(data, key):
    key = (key * (len(data) / len(key) + 1))[:len(data)]
    return strxor(data, key)

poem = open(&#39;cipher&#39;, &#39;r&#39;).read()
flag = &#39;6o71i6_i+te7es1ing!@#&#39;
for i in letters + digits +&#39;_&#39;:
    l = list(flag)
    l[0] = i
    print &#39;+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++&#39;
    print i
    print enc(base64.b64decode(poem), &#39;&#39;.join(l))
    print &#39;-----------------------------------------------------------------------&#39;
</code></pre>
<p>可以看到，最后一行那个单词明显应该是autumn</p>
<p><img src="/2018/11/12/CTF-HCTF-2018-crypto/4.jpg" alt=""></p>
<p>那么对应的字母是x，然后我们再用这个密钥<code>xo71i6_i+te7es1ing!@#</code>，通过查看poem里面残缺了一个字母的单词，找到对应的位置，依此去跑就能得到flag</p>
<p>看了别人的wp，我发现有人用了xortool这个工具，<a href="https://github.com/hellman/xortool" target="_blank" rel="noopener">github地址</a></p>
<blockquote>
<p>这里我直接用<code>xortool</code>，将密文转为hex，指定空格为最常见字符: <code>python xortool -x -c 20 c.txt</code></p>
</blockquote>
<p>我实际测了一下，这个工具和那个作者的脚本效果差不多</p>
<h3 id="原理"><a href="#原理" class="headerlink" title="原理"></a>原理</h3><p>我觉得还是要研究一下原理，那个作者的文章是全英文的，不太容易看懂，我做一个补充</p>
<p>依据原文的两个加密的例子：</p>
<pre><code>84, 72, 73, 83, 32, 73, 83, 32, 65, 32, 77, 69, 83, 83, 65, 71, 69
89, 79, 85, 89, 79, 85, 89, 79, 85, 89, 79, 85, 89, 79, 85, 89, 79
xor --------------------------------------------------------------
13,  7, 28, 10,111, 28, 10,111, 20,121,  2, 16, 10, 28, 20, 30, 10
</code></pre><p>首先之所以有<code>28, 10,111</code>的重复，是因为明文里面有一个<code>is</code>的重复，这两个重复间隔的位数是0（3的倍数）</p>
<pre><code>84, 72, 73, 83, 32, 77, 69, 83, 83, 65, 71, 69, 32, 73, 83, 32, 78, 79, 84
89, 79, 85, 89, 79, 85, 89, 79, 85, 89, 79, 85, 89, 79, 85, 89, 79, 85, 89
xor ----------------------------------------------------------------------
13,  7, 28, 10,111, 24, 28, 28,  6, 24,  8, 16,121,  6,  6,121,  1, 26, 13
</code></pre><p>如果<code>is</code>隔了8个字符，不是3的倍数了，那么这个<code>28, 10,111</code>的重复也就不存在</p>
<p>也就是说，通过长度为3的key，使得明文进行了分组，而至少有些时候，重复的明文会因此而偏移（情况一），我们通过一个粗略的算法（代码里的shift函数）， 使密文经过len(key)偏移一次，然后与之前的密文对比，有多少bytes相同，如果相同的次数比较多，就说明明文加密后很可能进行了这么长的偏移，而这么长的偏移就是key的长度造成的，所以可以大致推测出key的长度</p>
<p>一旦我们得到了key的长度，那么我们可以说，明文其实可以想象成分成了很多行进行加密，然后再将他们加密的结果拼接起来，那么对于每一列，都使用的是同一个key的某一位进行加密，那么对于加密的结果应该符合频率分布规律， 出现最高的频率应该是空格（这也就是为什么键盘的空格键在最下方中间而且那么长的原因了= =）被加密的密文，因此将密文和空格异或就能推测出这位key了。从0到len(key)列做重复的操作就能粗略的得到一个key，也就可以用来加密明文了</p>
<hr>
<h2 id="xor-rsa"><a href="#xor-rsa" class="headerlink" title="xor?rsa"></a>xor?rsa</h2><p>首先我拿到这道题的时候以为这是出题人自己想出来的一种攻击手法，然后用出了自己学过的所有数论知识和异或的公式尝试去化简和推导，结果整整2天没有一点进展</p>
<p>当时我google和百度了好久，就是没有找到这种攻击方式，后来请教了别队的师傅，他说这个攻击手法在ctf-wiki上有，攻击手法叫<code>Coppersmith’s short-pad attack</code></p>
<blockquote>
<h3 id="攻击条件"><a href="#攻击条件" class="headerlink" title="攻击条件"></a>攻击条件</h3><p>目前在大部分消息加密之前都会进行 padding，但是如果 padding 的长度过短，也有<strong>可能</strong>被很容易地攻击。</p>
<p>这里所谓 padding 过短，其实就是对应的多项式的根会过小。</p>
</blockquote>
<p>在百度上找到了一个现成的轮子，<a href="https://github.com/ValarDragon/CTF-Crypto/blob/master/RSA/FranklinReiter.sage" target="_blank" rel="noopener">github地址</a></p>
<p>这个轮子是sage代码，在命令行里面用<code>sage ***.sage</code>直接运行，<a href="https://sagecell.sagemath.org/" target="_blank" rel="noopener">也可以在线运行</a></p>
<p>直接抄过来跑的话会报错，Eur3kA队的wp是对<code>CoppersmithShortPadAttack</code>函数以及传入eps的值做了一点改动，不是很懂怎么改的（太菜了）</p>
<pre><code class="lang-python">def CoppersmithShortPadAttack(e,n,C1,C2,eps=1/30):
    import binascii
    P.&lt;x,y&gt; = PolynomialRing(ZZ)
    ZmodN = Zmod(n)
    g1 = x^e - C1
    g2 = (x+y)^e - C2
    res = g1.resultant(g2)
    P.&lt;y&gt; = PolynomialRing(ZmodN)
    rres = 0
    for i in range(len(res.coefficients())):
        rres += res.coefficients()[i]*(y^(res.exponents()[i][1]))

    diff = rres.small_roots(epsilon=eps)
    recoveredM1 = franklinReiter(n,e,diff[0],C1,C2)
    print(diff)
    print(recoveredM1)
    print(recoveredM1 + diff[0])
</code></pre>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>首先第一题，我觉得当时如果仔细看了明文，能够注意到已经还原了部分单词的话，就能坚持做下去的，虽然同队的师傅后来也做出了这道题，影响不是很大，但是对于自己来说，还是欠了一点坚持</p>
<p>对于第二题，这种不能用简单的数论解决的题目应该都是一种单独的攻击面，后续的学习可能要参照ctf-wiki了= =</p>
<h2 id="参考文章"><a href="#参考文章" class="headerlink" title="参考文章"></a>参考文章</h2><p>[1]<a href="https://xz.aliyun.com/t/3242#toc-18" target="_blank" rel="noopener">HCTF 2018 Writeup — Whitzard</a></p>
<p>[2]<a href="https://xz.aliyun.com/t/3253#toc-24" target="_blank" rel="noopener">HCTF2018 Writeup — Eur3kA</a></p>
</section>
    <!-- Tags START -->
    
      <div class="tags">
        <span>Tags:</span>
        
  <a href="/tags#Crypto" >
    <span class="tag-code">Crypto</span>
  </a>

      </div>
    
    <!-- Tags END -->
    <!-- NAV START -->
    
  <div class="nav-container">
    <!-- reverse left and right to put prev and next in a more logic postition -->
    
      <a class="nav-left" href="/2018/11/05/CTF-上海杯-crypto/">
        <span class="nav-arrow">← </span>
        
          上海杯-2018-crypto
        
      </a>
    
    
  </div>

    <!-- NAV END -->
    <!-- 打赏 START -->
    
    <!-- 打赏 END -->
    <!-- 二维码 START -->
    
    <!-- 二维码 END -->
    
      <!-- Gitment START -->
      <div id="comments"></div>
      <!-- Gitment END -->
    
  </article>
  <!-- Article END -->
  <!-- Catalog START -->
  
    <aside class="catalog-container">
  <div class="toc-main">
    <strong class="toc-title">Catalog</strong>
    
      <ol class="toc-nav"><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#xor-game"><span class="toc-nav-text">xor game</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#题解"><span class="toc-nav-text">题解</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#原理"><span class="toc-nav-text">原理</span></a></li></ol></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#xor-rsa"><span class="toc-nav-text">xor?rsa</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#攻击条件"><span class="toc-nav-text">攻击条件</span></a></li></ol></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#总结"><span class="toc-nav-text">总结</span></a></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#参考文章"><span class="toc-nav-text">参考文章</span></a></li></ol>
    
  </div>
</aside>
  
  <!-- Catalog END -->
</main>

<script>
  (function () {
    var url = 'http://yoursite.com/2018/11/12/CTF-HCTF-2018-crypto/';
    var banner = ''
    if (banner !== '' && banner !== 'undefined' && banner !== 'null') {
      $('#article-banner').css({
        'background-image': 'url(' + banner + ')'
      })
    } else {
      $('#article-banner').geopattern(url)
    }
    $('.header').removeClass('fixed-header')

     // error image
    $(".markdown-content img").on('error', function() {
      $(this).attr('src', 'http://file.muyutech.com/error-img.png')
      $(this).css({
        'cursor': 'default'
      })
    })

    // zoom image
    $(".markdown-content img").on('click', function() {
      var src = $(this).attr('src')
      if (src !== 'http://file.muyutech.com/error-img.png') {
        var imageW = $(this).width()
        var imageH = $(this).height()
        
        var zoom = ($(window).width() * 0.95 / imageW).toFixed(2)
        zoom = zoom < 1 ? 1 : zoom
        zoom = zoom > 2 ? 2 : zoom
        var transY = (($(window).height() - imageH) / 2).toFixed(2)

        $('body').append('<div class="image-view-wrap"><div class="image-view-inner"><img src="'+ src +'" /></div></div>')
        $('.image-view-wrap').addClass('wrap-active')
        $('.image-view-wrap img').css({
          'width': `${imageW}`,
          'transform': `translate3d(0, ${transY}px, 0) scale3d(${zoom}, ${zoom}, 1)`
        })
        $('html').css('overflow', 'hidden')

        $('.image-view-wrap').on('click', function() {
          $(this).remove()
          $('html').attr('style', '')
        })
      }
    })

    // qrcode
    var qr = new QRious({
      element: document.getElementById('share-qrcode'),
      value: document.location.href
    });

    // gitment
    var gitmentConfig = "R1ng6";
    if (gitmentConfig !== 'undefined') {
      var gitment = new Gitment({
        id: "HCTF-2018-crypto和一些思考",
        owner: "R1ng6",
        repo: "R1ng6.github.io",
        oauth: {
          client_id: "adbd0ebe7176ad319aed",
          client_secret: "e18990d6808181ce7080a1775db8140e2da1b55c"
        },
        theme: {
          render(state, instance) {
            const container = document.createElement('div')
            container.lang = "en-US"
            container.className = 'gitment-container gitment-root-container'
            container.appendChild(instance.renderHeader(state, instance))
            container.appendChild(instance.renderEditor(state, instance))
            container.appendChild(instance.renderComments(state, instance))
            container.appendChild(instance.renderFooter(state, instance))
            return container;
          }
        }
      })
      gitment.render(document.getElementById('comments'))
    }
  })();
</script>

<script>
  var disqus_shortname = '';
  
  var disqus_url = 'http://yoursite.com/2018/11/12/CTF-HCTF-2018-crypto/';
  
  (function(){
    var dsq = document.createElement('script');
    dsq.type = 'text/javascript';
    dsq.async = true;
    dsq.src = '//go.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
  })();
</script>

    <div class="scroll-top">
  <span class="arrow-icon"></span>
</div>
    <footer class="app-footer">
  <p class="copyright">
    &copy; 2019 | Proudly powered by <a href="https://hexo.io" target="_blank">Hexo</a>
    <br>
    Theme by <a href="https://github.com/yanm1ng">yanm1ng</a>
  </p>
</footer>

<script>
  function async(u, c) {
    var d = document, t = 'script',
      o = d.createElement(t),
      s = d.getElementsByTagName(t)[0];
    o.src = u;
    if (c) { o.addEventListener('load', function (e) { c(null, e); }, false); }
    s.parentNode.insertBefore(o, s);
  }
</script>
<script>
  async("//cdn.bootcss.com/fastclick/1.0.6/fastclick.min.js", function(){
    FastClick.attach(document.body);
  })
</script>

<script>
  var hasLine = 'false';
  async("//cdn.bootcss.com/highlight.js/9.12.0/highlight.min.js", function(){
    $('figure pre').each(function(i, block) {
      var figure = $(this).parents('figure');
      if (hasLine === 'false') {
        figure.find('.gutter').hide();
      }
      var lang = figure.attr('class').split(' ')[1] || 'code';
      var codeHtml = $(this).html();
      var codeTag = document.createElement('code');
      codeTag.className = lang;
      codeTag.innerHTML = codeHtml;
      $(this).attr('class', '').empty().html(codeTag);
      figure.attr('data-lang', lang.toUpperCase());
      hljs.highlightBlock(block);
    });
  })
</script>
<!-- Baidu Tongji -->

<script src="/js/script.js"></script>
  </body>
</html>